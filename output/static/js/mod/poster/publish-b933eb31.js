define([],function(e,t,n){function r(e){var t=e.find(".dnu-start"),n=e.find(".dnu-end");t.datetimepicker({format:"Y-m-d H:i",lang:"ch",maxDate:!1,onShow:function(e){var t=n.val();this.setOptions({maxDate:t?utils.dateFormat(t,"/"):!1})},timepicker:!0}),n.datetimepicker({format:"Y-m-d H:i",lang:"ch",minDate:!1,onChangeDateTime:function(){},onShow:function(e){var n=t.val();this.setOptions({minDate:n?utils.dateFormat(n,"/"):!1})},timepicker:!0})}function i(e,t){this.options=$.extend({picker:null,containerSelector:".file-box",mimeType:"image",success:function(){}},t),this.$container=$(this.options.picker).parents(this.options.containerSelector);var n=this,r=WebUploader.create({auto:!0,swf:"/static/webuploader/Uploader.swf",server:"/upload/media",pick:this.options.picker,dnd:".files",fileVal:"file",chunked:!0,formData:{__no_retain__:"ok",bucketType:{image:1,audio:2,other:3}[this.options.mimeType]||3},fileSingleSizeLimit:1e7,duplicate:!1,thumb:{width:400,height:400,crop:!0},compress:{width:2400,height:2400,crop:!1,preserveHeaders:!0,noCompressIfLarger:!0},accept:this.getMIME(this.options.mimeType)});r.on("filesQueued",function(e){_.each(e,function(e,t){var i=n.getMIMEType(e);if(i!="image")return;r.makeThumb(e,function(e,t){if(e)return utils.bubble("错误");$(n.options.picker).parents(n.options.containerSelector).find(".preview-container").html($("<img />").attr("src",t))})})}),r.on("uploadSuccess",function(e,t){var r=$(n.options.picker).parents(n.options.containerSelector).find(".progress-stick").width("100%");if(t.node_code!==2e4)return $(n.options.picker).parents(n.options.containerSelector).addClass("warn");setTimeout(function(){utils.bubble("上传成功！"),r.hide()},400),n.options.success.call(n,t,e)}),r.on("uploadProgress",function(e,t){$(n.options.picker).parents(n.options.containerSelector).find(".progress-stick").show().width(t*62+"%")}),r.on("error",function(e){var t=this.getFiles().length;switch(e){case"Q_TYPE_DENIED":alert("资源类型错误！");break;case"Q_EXCEED_NUM_LIMIT":utils.bubble("分批文件限制为"+t+"个！（可再次追加）");break;case"Q_EXCEED_SIZE_LIMIT":alert("文件体积过大");break;case"F_EXCEED_SIZE":alert("文件体积过大")}}),r.on("uploadError",function(e,t){utils.bubble("上传错误！")})}function s(e){e.on("click",".btn-submit",function(t){var n=null;e.find("form").ajaxSubmit({beforeSubmit:function(){var t=e.find("input[name=link]").val(),r=e.find("input[name=imageUrl]").val(),i=e.find("input[name=startDate]").val(),s=e.find("input[name=endDate]").val(),o=e.find("select[name=type]").val(),u=e.find("select[name=linkType]").val();return t==""?(utils.bubble("请填写链接地址"),!1):i==""?(utils.bubble("请选择开始日期"),!1):s==""?(utils.bubble("请选择结束日期"),!1):u==0?(utils.bubble("请选择链接类型"),!1):o==0?(utils.bubble("请选择banner方式"),!1):r==""?(utils.bubble("请上传banner图片"),!1):(n=utils.loading(),!0)},uploadProgress:function(){},success:function(e,t){e["node_code"]!=2e4?utils.bubble(e.msg):(utils.bubble("添加banner成功"),_SmartPipe_.reload()),n.remove()},fail:function(e,t){utils.bubble("上传失败了")}})})}function o(e){}function u(e){r(e),s(e),o(e)}return $.extend(i.prototype,{init:function(){},getMIMEType:function(e){var t=e.type.split("/")[0].toLowerCase();return t},getMIME:function(e){e||(e="image");var t={image:{title:"Images",mimeTypes:"image/jpg,image/jpeg,image/png"},audio:{title:"Audio",extensions:"mp3,aac",mimeTypes:"audio/mp3,audio/aac"},text:{title:"Text",mimeTypes:"*/*"}};return t[e]}}),{init:function(e){var t=$(".mod-poster-publish");u(t),setTimeout(function(e){new i(t,{picker:t.find(".file-box").eq(0).find(".file-picker")[0],mimeType:"image",success:function(e,t){var n=e.data.resp;this.$container.find("input[type=hidden].file-hidden").val(n.key)}})},1e3)}}})