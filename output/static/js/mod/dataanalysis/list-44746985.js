define(["ec/echarts-all"],function(){function e(e){var t={},n=e.length;for(var r=0;r<e.length;r++){var i=e[r];for(var s=0;s<i.length;s++)if(i.length>0){var o=i[s],u=o[0];t[u]||(t[u]=Array.apply(null,Array(n)).map(Number.prototype.valueOf,0)),t[u][r]=o[1]}}return t}function t(e){e=$.extend({container:null,from:"",to:"",url:"/_bridge/admin/userstatistics/alldata",type:1},e),this.options=e,this.init()}function n(e){e==null&&(e="北京");switch(e.substring(0,2)){case"北京":return"北京";case"天津":return"天津";case"河北":return"河北";case"山西":return"山西";case"山东":return"山东";case"河南":return"河南";case"陕西":return"陕西";case"辽宁":return"辽宁";case"吉林":return"吉林";case"内蒙":return"内蒙古";case"黑龙":return"黑龙江";case"江苏":return"江苏";case"安徽":return"安徽";case"湖北":return"湖北";case"重庆":return"重庆";case"上海":return"上海";case"浙江":return"浙江";case"江西":return"江西";case"湖南":return"湖南";case"贵州":return"贵州";case"福建":return"福建";case"广东":return"广东";case"广西":return"广西";case"宁夏":return"宁夏";case"四川":return"四川";case"云南":return"云南";case"台湾":return"台湾";case"香港":return"香港";case"澳门":return"澳门";case"海南":return"海南";case"甘肃":return"甘肃";case"青海":return"青海";case"西藏":return"西藏";case"新疆":return"新疆";default:return"北京"}}function r(e){var t=e.find(".statistics-start"),n=e.find(".statistics-end");t.datetimepicker({format:"Y-m-d",lang:"ch",maxDate:utils.dateFormat(new Date,"/"),onShow:function(e){var t=n.val();this.setOptions({maxDate:t?utils.dateFormat(t,"/"):!1})},timepicker:!1}),n.datetimepicker({format:"Y-m-d",lang:"ch",minDate:!1,maxDate:utils.dateFormat(new Date,"/"),onChangeDateTime:function(){},onShow:function(e){var n=!1,r=t.val();this.setOptions({minDate:r?utils.dateFormat(r,"/"):!1})},timepicker:!1})}function i(e){var n=e.find(".statistics-start"),r=e.find(".statistics-end");e.on("click",".btn-date-click",function(i){var s=n.val(),o=r.val(),u=s||o;if(!s&&!o)return utils.bubble("请选择至少一个日期");new t({container:e.find(".diagram-box")[0],from:s,to:o,type:$(".mod-statistics").data("type")})})}function s(e){e.on("click",".corner .remove",function(e){$(this).parents(".input").find("input").val("")})}function o(e){e.on("click",".btn-current-month",function(n){var r=e.find(".statistics-start"),i=e.find(".statistics-end"),s=(new Date).getFullYear(),o=(new Date).getMonth()+1,u=(new Date(s,o,0)).getDate(),a=utils.dateFormat([s,o,1].join("-")),f=utils.dateFormat([s,o,u].join("-"));r.val(a),i.val(f),new t({container:e.find(".diagram-box")[0],url:e.data("type")==1?"/_bridge/admin/userstatistics/userstatistics":undefined,from:a,to:f,type:$(".mod-statistics").data("type")})})}function u(e){e.on("click",".btn-current-week",function(n){var r=e.find(".statistics-start"),i=e.find(".statistics-end"),s=new Date,o=s.getFullYear(),u=s.getMonth()+1,a=s.getDay(),f=a-1,l=7-a,c=864e5,h=utils.dateFormat(+s-f*c),p=utils.dateFormat(+s+l*c);r.val(h),i.val(p),new t({container:e.find(".diagram-box")[0],timeType:"week",url:e.data("type")==1?"/_bridge/admin/userstatistics/userstatistics":undefined,type:e.data("type"),from:h,to:p})})}function a(e){e.on("click",".btn-today",function(n){var r=e.find(".statistics-start"),i=e.find(".statistics-end"),s=utils.dateFormat(new Date),o=utils.dateFormat(new Date);r.val(s),i.val(o),new t({container:e.find(".diagram-box")[0],url:e.data("type")==1?"/_bridge/admin/userstatistics/userstatistics":undefined,from:s,to:o,type:$(".mod-statistics").data("type")})})}function f(e){i(e),o(e),u(e),a(e),s(e)}return $.extend(t.prototype,{init:function(){this.render()},render:function(){var t=this,r=this.options,i=r.container,s=echarts.init(i);this.fetchData(function(t){var i=r.from,o=r.to,u=r.url,a=r.type,f=t.data.resp.data,l=[],c=[],h=[];if(a==1){h=e(f);for(var p in h)l.push({name:p,type:"line",data:h[p],markPoint:{data:[{type:"max",name:"最大值"},{type:"min",name:"最小值"}]},markLine:{data:[{type:"average",name:"平均值"}]}}),c.push(p);if(i==o&&l.length==0)return utils.bubble("您查询的当天没有数据");var d={tooltip:{trigger:"axis"},legend:{data:c},toolbox:{show:!0,feature:{dataView:{show:!0,readOnly:!1},restore:{show:!0},saveAsImage:{show:!0}}},yAxis:[{type:"value"}]},v=utils.getDaysArray(+(new Date(i)),+(new Date(o)));r.timeType=="week"&&(v=utils.getDaysOfWeek()),d.xAxis=[{type:"category",data:v}],d.series=l}else if(a==2){var m=[],g="",y=0;for(var b=0;b<f.length;b++)m.push({name:n(f[b][0]),value:f[b][1]});d={tooltip:{trigger:"item"},dataRange:{min:0,max:3e3,color:["#FF0000","#FFCC00"],x:"left",y:"bottom",text:["高","低"],calculable:!0},toolbox:{show:!0,orient:"vertical",x:"right",y:"center",feature:{dataView:{show:!0,readOnly:!1},restore:{show:!0},saveAsImage:{show:!0}}},roamController:{show:!0,x:"right",mapTypeControl:{china:!0}},series:[{name:g,type:"map",mapType:"china",data:m,roam:!0,itemStyle:{normal:{label:{show:!0}},emphasis:{label:{show:!0}}}}]}}s.setOption(d)})},fetchData:function(e){var t=this.options,n=t.container,r=t.from,i=t.to,s=t.url,o=null;o=utils.loading(),utils.api(s,{method:"get",data:{from:r,to:i,type:t.type}}).done(function(t,n){if(t["node_code"]!=2e4)return o.remove(),utils.bubble(t.data.msg);e(t),o.remove()})},setUrl:function(e){this.options.url=e}}),{init:function(){var e=$(".mod-statistics");f(e),r(e),function(){e.find(".btn-current-week").click()}(),e.find(".btn-today").hide()}}})