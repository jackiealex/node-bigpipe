define([],function(e,t,n){function i(e,t){this.options=$.extend({picker:null,containerSelector:".file-box",mimeType:"image",success:function(){}},t),this.$container=$(this.options.picker).parents(this.options.containerSelector);var n=this,r=this.uploader=WebUploader.create({auto:!0,swf:"/static/webuploader/Uploader.swf",server:"/upload/media",pick:this.options.picker,dnd:".files",fileVal:"file",chunked:!0,formData:{__no_retain__:"ok",bucketType:{image:1,audio:2,other:3}[this.options.mimeType]||3},fileSingleSizeLimit:1e7,duplicate:!1,thumb:{width:400,height:400,crop:!0},compress:{width:2400,height:2400,crop:!1,preserveHeaders:!0,noCompressIfLarger:!0},accept:this.getMIME(this.options.mimeType)});r.on("filesQueued",function(e){_.each(e,function(e,t){var i=n.getMIMEType(e);if(i!="image")return;r.makeThumb(e,function(e,t){if(e)return utils.bubble("错误");$(n.options.picker).parents(n.options.containerSelector).find(".preview-container").html($("<img />").attr("src",t))})})}),r.on("uploadSuccess",function(e,t){var r=$(n.options.picker).parents(n.options.containerSelector).find(".progress-stick").width("100%");if(t.node_code!==2e4)return r.hide(),$(n.options.picker).parents(n.options.containerSelector).addClass("fail");setTimeout(function(){utils.bubble("上传成功！"),r.hide()},400),n.options.success.call(n,t,e)}),r.on("uploadProgress",function(e,t){$(n.options.picker).parents(n.options.containerSelector).find(".progress-stick").show().width(t*62+"%")}),r.on("error",function(e){var t=this.getFiles().length;switch(e){case"Q_TYPE_DENIED":alert("资源类型错误！");break;case"Q_EXCEED_NUM_LIMIT":utils.bubble("分批文件限制为"+t+"个！（可再次追加）");break;case"Q_EXCEED_SIZE_LIMIT":alert("文件体积过大");break;case"F_EXCEED_SIZE":alert("文件体积过大")}}),r.on("uploadError",function(e,t){utils.bubble("上传错误！")})}function s(e){e.on("click",".btn-submit",function(t){var n=null;e.find("form").ajaxSubmit({beforeSubmit:function(){return n=utils.loading(),!0},uploadProgress:function(){},success:function(e,t){if(e["node_code"]!=2e4)return utils.bubble(e.msg);utils.bubble("发布成功"),_SmartPipe_.reload(),n.remove()},fail:function(e,t){utils.bubble("上传失败了")}})})}function o(e){e.on("click",".btn-delete",function(e){var t=$(this).parents(".file-box"),n=t.parents(".files").find(".file-box").index(t[0]);t.removeClass("succ fail warn"),t.find("input[type=hidden].file-hidden").val(""),t.find(".btn-preview").attr("href","#"),r[n].uploader.reset()})}function u(e){s(e),o(e)}var r=[];return $.extend(i.prototype,{init:function(){},getMIMEType:function(e){var t=e.type.split("/")[0].toLowerCase();return t},getMIME:function(e){e||(e="image");var t={image:{title:"Images",mimeTypes:"image/jpg,image/jpeg,image/png"},audio:{title:"Audio",extensions:"mp3,aac",mimeTypes:"audio/mp3,audio/aac"},text:{title:"Text",mimeTypes:"*/*"}};return t[e]}}),{init:function(e){var t=$(".mod-music-publish");u(t),setTimeout(function(e){r[0]=new i(t,{picker:t.find(".file-box").eq(0).find(".file-picker")[0],mimeType:"audio",success:function(e,t){var n=e.data.resp;this.$container.find("input[type=hidden].file-hidden").val(n.key),this.$container.find(".btn-preview").attr("href",n.url),this.$container.addClass("succ")}})},100),setTimeout(function(e){r[1]=new i(t,{picker:t.find(".file-box").eq(1).find(".file-picker")[0],mimeType:"audio",success:function(e,t){var n=e.data.resp;this.$container.find("input[type=hidden].file-hidden").val(n.key),this.$container.find(".btn-preview").attr("href",n.url)}})},300),setTimeout(function(e){r[2]=new i(t,{picker:t.find(".file-box").eq(2).find(".file-picker")[0],mimeType:"audio",success:function(e,t){var n=e.data.resp;this.$container.find("input[type=hidden].file-hidden").val(n.key),this.$container.find(".btn-preview").attr("href",n.url)}})},500),setTimeout(function(e){r[3]=new i(t,{picker:t.find(".file-box").eq(3).find(".file-picker")[0],mimeType:"audio",success:function(e,t){var n=e.data.resp;this.$container.find("input[type=hidden].file-hidden").val(n.key),this.$container.find(".btn-preview").attr("href",n.url)}})},700),setTimeout(function(e){r[4]=new i(t,{picker:t.find(".file-box").eq(4).find(".file-picker")[0],mimeType:"text",success:function(e,t){var n=e.data.resp;this.$container.find("input[type=hidden].file-hidden").val(n.key),this.$container.find(".btn-preview").attr("href",n.url)}})},900),setTimeout(function(e){r[5]=new i(t,{picker:t.find(".file-box").eq(5).find(".file-picker")[0],mimeType:"image",success:function(e,t){var n=e.data.resp;this.$container.find("input[type=hidden].file-hidden").val(n.key)}})},1e3)}}})