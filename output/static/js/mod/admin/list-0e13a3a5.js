define(["base/md5"],function(e){function r(e){e.on("dblclick",".item",function(e){var n=$(this),r=n.data("id"),i=n.find(".username").text(),s=dialog({title:"修改的"+i+"信息",align:"bottom left",content:"正在获取信息.......",ok:function(){var e=$(this.node),t=e.find("input[name=nickname]").val(),n=e.find("input[name=email]").val(),i=e.find("textarea[name=content]").val();return t=$.trim(t),n=$.trim(n),i=$.trim(i),t?n?(utils.api("/_bridge/admin/"+r+"/update",{method:"post",data:{id:r,nickname:t,email:n,content:i}}).done(function(e,t){if(e["node_code"]!=2e4)return utils.bubble(e.msg||e.data.msg);_SmartPipe_.reload(),utils.bubble("修改成功")}),!0):utils.bubble("邮箱不能为空！"):utils.bubble("昵称不能为空！")},cancel:function(){return!0},okValue:"提交",cancelValue:"取消"});s.showModal(),utils.api("/_bridge/admin/"+r+"",{}).done(function(e,n){var r=e.data.resp.admin;r=$.extend({content:"",email:""},r),s.content(utils.xTemplate(t,r))})})}function i(e){e.on("click",".btn-preview-roles",function(e){var t=$(this).parents(".item"),n=t.data("id"),r=t.find(".username").text(),i=t.find(".nickname").text(),s=t.find(".email").text(),o=dialog({title:r+"的角色",align:"bottom left",content:'<div class="ui" style="width: 200px; height: 200px;"> <div class="ui active loader"> </div></div>',onshow:function(e){$(this.node).on("click",".item .remove",function(e){var t=$(this).parents(".item"),r=$(this).data("id");debugger;utils.api("/_bridge/admin/"+n+"/roles?roleId="+r,{method:"delete",data:{roleId:r}}).done(function(e,n){if(e["node_code"]!=2e4)return utils.bubble(e.data.msg);utils.bubble("角色已移除");if(t.siblings().length==0){o.content('<div style="width: 400px;padding: 100px;text-align: center;">没有分配角色</div>');return}t.remove()})})}});o.showModal(),utils.api("/admin/ones/role",{dataType:"text",data:{__pipe__:1,id:n}}).done(function(e){(typeof e).toLowerCase()=="string"&&o.content(e)})})}function s(e){e.on("click",".btn-alloc-role",function(){var e=$("#sideBar").find(".role-panel"),t=$(this);if(e.length==1){e.is(":visible")?(e.remove(),t.find("span").text("分配角色")):t.find("span").text("取消分配");return}if(t.hasClass("loading-effect"))return utils.bubble("等待");t.addClass("loading-effect"),utils.api("/admin/alloc/role",{method:"get",dataType:"text",data:{__pipe__:1}}).done(function(e,n){t.find("span").text("取消分配"),$("#sideBar").append(e),t.removeClass("loading-effect"),$("#sideBar").find(".role-panel .role").draggable({})})})}function o(e){e.on("click",".input .search",function(e){var t=$(this).prev().val();if(!t)return e.stopPropagation(),e.preventDefault(),!1;_SmartPipe_.location("/admin/list?key="+t)}),e.on("click",".input .label",function(e){_SmartPipe_.location("/admin/list")}),e.on("keyup",".input input",function(e){e.keyCode==13&&$(this).next().trigger("click")})}function u(e){$("#sideBar").on("click",".close",function(t){$("#sideBar").find(".role-panel").remove(),e.find(".btn-alloc-role").find("span").text("分配角色")})}function a(t){t.on("click",".privacy",function(t){var r=$(this).parents(".item"),i=r.data("id"),s=r.find(".username").text(),o=dialog({title:"修改"+s+"的密码",align:"bottom left",content:n,ok:function(){var t=$(this.node).find("input").eq(0).val(),n=$(this.node).find("input").eq(1).val();return t=$.trim(t),n=$.trim(n),t.length<6?utils.bubble("长度不能少于6位！"):t?n!=t?(utils.bubble("密码不一致！"),!1):(utils.api("/_bridge/admin/"+i+"/password",{method:"post",data:{password:e(t)}}).done(function(e,t){if(e["node_code"]!=2e4)return utils.bubble(e.data.msg);utils.bubble("密码已经修改"),_SmartPipe_.reload()}),!0):(utils.bubble("密码不能为空！"),!1)},okValue:"提交",cancelValue:"取消",cancel:function(){return!0}});o.showModal()})}function f(e){o(e),r(e),a(e),i(e),s(e),l(e)}function l(e){e.find("tr").droppable({}).on(" dragenter  ",function(){$(this).addClass("target")}).on("dragleave",function(){$(this).removeClass("target")}).on("drop",function(e){$(this).removeClass("target");var t=$(e.currentTarget.lastChild),n=$(this).data("id"),r=$(this).find(".email").text(),i=$(this).find(".nickname").text(),s=t.data("id");t.remove();var o=$(this);o.append($('<div class="ui "> <div class="ui active inline inverted dimmer"> <div class="ui text loader"></div> </div> <p></p> </div> ')),utils.api("/_bridge/admin/"+n+"/roles",{method:"post",data:{roleId:s}}).done(function(e,t){if(e["node_code"]!=2e4)return utils.bubble(e.data.msg);utils.bubble("分配成功！"),o.find(">.ui").remove(),$("#sideBar").find(".role-panel .role").draggable({}).on("dragstart",function(){$(this).addClass("dragging")}).on("dragend",function(e){$(this).removeClass("dragging")})})})}var t=['<div class="ui warning form basics" style="width: 400px">','    <div class="field">',"        <label>ID</label>",'        <input type="text" name="id" value="<%= id %>" readonly />',"    </div>",'    <div class="field">',"        <label>昵称</label>",'        <input type="text" name="nickname" value="<%= nickname %>" />',"    </div>",'    <div class="field">',"        <label>邮箱</label>",'        <input type="text" name="email" value="<%= email %>" />',"    </div>",'    <div class="field">',"        <label>备注</label>",'        <textarea name="content" style="height: 50px" ><%= content %></textarea>',"    </div>","</div>"].join(""),n=['<div class="ui warning form basics" style="width: 400px">','    <div class="field">',"        <label>新密码</label>",'        <input type="password" name="password" value="" />',"    </div>",'    <div class="field">',"        <label>确认新密码</label>",'        <input type="password" name="password" value="" />',"    </div>","</div>"].join("");return{init:function(){var e=$(".mod-admin-list");f(e),u(e)}}})