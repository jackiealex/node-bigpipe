define(["libs/query-string"],function(e){var t=Backbone.View.extend({initialize:function(e){this.initDatePicker(),this.stopElePropagation(),e=$.extend({defaultPathname:"/user/list?"},e),this.options=e},events:{"click .header .menu .item":"searchByFilter","keyup .header .input input":"searchByEnterKey","click .header .button.search":"search","click .header .dropdown.button .remove, .field .remove":"onRemoveCondition","change .is-quality-change":"qualityCheck","change .is-enabled-user-change":"isEnabledChange","click .header .dropdown":"onShowCondition","click .list .item .btn-order":"setUserOrder","click .icon.remove":"onRemoveKey","click .list .item div[name=top_cancel]":"cancelUserTop","click .list .item i[name=top_setting]":"setUserTopByTimer"},searchByFilter:function(t){var n=this.$el,r=e.parse(location.search),i=$(this).data("field"),s=$(this).data("value"),o={};o[i]=s,o=$.extend(r,o),o.page=1,_SmartPipe_.location(this.options.defaultPathname+$.param(o))},searchByEnterKey:function(e){var t=this.$el;e.keyCode==13&&$(e.currentTarget).parents(".header").find(".button.search").click()},search:function(t){var n=this.$el,r=$(t.currentTarget).parents(".header").find("input").val(),i=$(t.currentTarget).parents(".header").find(".dnu-create").val(),s=e.parse(location.search);delete s.nickname,r&&(s.nickname=r),i&&(s.createDate=i),s.page=1,_SmartPipe_.location(this.options.defaultPathname+$.param(s))},onRemoveCondition:function(t){var n=this.$el,r=e.parse(location.search);return delete r[$(t.currentTarget).parents(".field").data("field")],_SmartPipe_.location(this.options.defaultPathname+$.param(r)),!1},qualityCheck:function(e){var t=this.$el,n=$(e.currentTarget).prop("checked");if(n!=0)var r=1;else var r=0;var i=$(this).attr("data"),s="/_bridge/user/quality/set",o={method:"post",data:{ids:i,isQuality:r}};$loading=utils.loading(),utils.api(s,o).done(function(e,t){e["node_code"]==2e4&&utils.bubble("设置成功"),$loading.remove()})},isEnabledChange:function(e){var t=this.$el,n=$(e.currentTarget).prop("checked"),r=$(e.currentTarget).attr("data"),i="/_bridge/disabled/user";if(n){var s=dialog({title:"禁用原因",content:['<div class="ui left icon input">','    <input type="text" placeholder="原因必填" />','    <i class="mail icon"></i>',"</div>"].join(""),okValue:"确定",cancelValue:"取消",ok:function(){var e=$(this.node).find("input").val();return e=$.trim(e),e==""?(utils.bubble("必须填写原因"),!1):(utils.api(i,{method:"post",data:{userId:r,reason:e}}).done(function(e){e["node_code"]==2e4&&(utils.bubble("处理成功"),_SmartPipe_.reload())}),!0)},cancel:function(){return!0}});return s.showModal(),e.stopPropagation(),!1}return utils.api(i+"?id="+r,{method:"delete"}).done(function(e){e["node_code"]==2e4&&(utils.bubble("处理成功"),_SmartPipe_.reload())}),!1},onShowCondition:function(e){console.log("dropdown click");var t=this.$el,n=$(e.currentTarget).find(".menu");return n.is(":visible")?n.removeClass("visible transition"):n.addClass("visible transition"),e.stopPropagation()},initDatePicker:function(){var e=this.$el,t=e.find(".dnu-create");t.datetimepicker({format:"Y-m-d",lang:"ch",minDate:!1,maxDate:utils.dateFormat(new Date,"/"),onChangeDateTime:function(){},onShow:function(e){},timepicker:!1})},setUserTopByTimer:function(e){var t=this.$el,n=$(e.currentTarget).parents(".item"),r=n.data("id");n.addClass("yellow");var i=dialog({title:"设定置顶",align:"bottom left",width:200,content:['<div class="fields">',' <div class=" field inline">','     <div class="ui small icon input   corner labeled  ">','            <input readonly="readonly" placeholder="开始日期" type="text" class="dnu-start" >','           <i class="calendar icon"></i>','           <div class="ui corner label" title="清除日期">','              <i class="remove icon"></i>',"         </div>","      </div>","  </div>","  <br />",'  <div class="field inline">','      <div class="ui small icon input   corner labeled  ">','            <input readonly="readonly" placeholder="结束日期" type="text" class="dnu-end" >','         <i class="calendar icon"></i>','           <div class="ui corner label" title="清除日期">','              <i class="remove icon"></i>',"         </div>","      </div>","  </div>","</div>"].join(""),onshow:function(){var e=$(this.node).find(".dnu-start"),t=$(this.node).find(".dnu-end");e.datetimepicker({format:"Y-m-d H:i",lang:"ch",maxDate:!1,onShow:function(e){var n=t.val();this.setOptions({maxDate:n?utils.dateFormat(n,"/"):!1})},timepicker:!0}),t.datetimepicker({format:"Y-m-d H:i",lang:"ch",minDate:!1,onChangeDateTime:function(){},onShow:function(t){var n=e.val();this.setOptions({minDate:n?utils.dateFormat(n,"/"):!1})},timepicker:!0})},ok:function(){var e=$(this.node).find(".dnu-start").val(),t=$(this.node).find(".dnu-end").val();if(e==null)return utils.bubble("请选择开始日期"),!1;if(t==null)return utils.bubble("请选择结束日期"),!1;utils.api("/_bridge/user/"+r+"/top",{method:"post",data:{startTime:e,endTime:t}}).done(function(e){if(e["node_code"]==2e4)return utils.bubble("设置成功！"),!0})},cancel:function(){return!0},okValue:"提交",cancelValue:"取消"});return i.showModal(),n.removeClass("yellow"),!1},setUserOrder:function(e){var t=this.$el;t.on("click",".list .item .btn-order",function(e){var t=utils.loading(),n=$(this).parents(".item"),r=$(this).parents(".input").find("input[type=number]").val(),i=n.data("id");utils.api("/_bridge/user/top/"+i+"/order",{method:"post",data:{order:r}}).done(function(e){if(e["node_code"]==2e4)return utils.bubble("设置成功！"),_SmartPipe_.reload(),t.remove(),!0})})},cancelUserTop:function(e){var t=this.$el,n=$(e.currentTarget).parents(".item"),r=n.data("id"),i=dialog({title:"取消置顶",align:"bottom left",width:300,content:'<div style="text-align: center; font-size: 20px">确定取消用户该段时间置顶？</div>',ok:function(){return $loading=utils.loading(),utils.api("/_bridge/user/top/"+r,{method:"delete"}).done(function(e){e["node_code"]==2e4&&(utils.bubble("取消成功！"),_SmartPipe_.reload()),$loading.remove()}),!0},cancel:function(){return!0},okValue:"提交",cancelValue:"取消"});i.showModal()},stopElePropagation:function(e){var t=this.$el;$("body").one("click",function(e){console.log("body click");var n=t.find(".header .dropdown").find(".menu");n.is(":visible")&&t.find(".header .dropdown").find(".menu").removeClass("visible transition")}),t.one("click",".header .dropdown .menu",function(e){return console.log("menu click"),!1})}});return t})