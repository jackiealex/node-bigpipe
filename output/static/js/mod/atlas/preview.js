define(function(){function i(){var t=$scope.find(".img-box-main");t.height(window.innerHeight-40),$img=$scope.find(".img img"),$imgContainer=$scope.find(".img");var n=$img.attr("src"),r=e.indexOf(n),i=$scope.find(".thumbs img").eq(r).data("ratio"),s=$imgContainer.outerWidth()/$imgContainer.outerWidth();s>i?$img.css({height:"100%",width:"auto"}):$img.css({width:"100%",height:"auto"})}function s(e){this.options=$.extend({list:[],mode:"loop"},e),this.list=e.list||[],this._cur=0,this._mode=this.options.mode}function o(e,t,n){utils.api("/check/someone/followed",{method:"get",data:{token:t,id:n}}).done(function(e,r){if(e["node_code"]!=2e4){utils.bubble(e.data.msg);return}e.data.resp.user.attention||u(t,n,function(){utils.bubble(name+" 自动关注了 "+$scope.find(".from .name").text())})})}function u(e,t,n){utils.api("/follow/someone",{method:"post",data:{token:e,userId:t}}).done(function(e,t){if(e["node_code"]!=2e4){utils.bubble(e.data.msg);return}n()})}function a(e){setTimeout(function(){utils.bubble("<b>温馨提示！</b> <br />双击评论就可以进行删除操作了")},2e3)}function f(e){e.on("click",".change-next",function(){utils.api("/_bridge/admin/random/user/list",{method:"get",data:{size:29}}).done(function(n,r){if(n["node_code"]!=2e4){utils.bubble(n.data.msg);return}var i=n.data.resp.users;e.find(".robot li").remove();for(var s=0;s<i.length;s++){var o=i[s],u=o.id,a=o.headUrl,f=o.nickname,l=_.template(t)({uid:u,headUrl:a,nickname:f});e.find(".robot").append(l)}e.find(".robot").append('<li class="change-next">换一批</li>'),e.find(".followers").addClass("show")})})}function c(e){e.on("click",".btn-comment",function(){if($(this).hasClass("disabled"))return utils.bubble("请等待当前评论完成！");var t=this,n=e.find("textarea").val().trim(),r=e.find(".robot .robotman.selected"),i=e.find(".speak-here .list .item.selected"),s=e.find(".speak-here .list .item.apply");if(!n)return utils.bubble("评论内容不能为空");if(r.length<1&&i.length<1)return utils.bubble("请在左侧选择一个用户");if(i.length==1&&s.length==1&&i.data("uid")==s.data("uid"))return utils.bubble("不能回复自己");var u=r.data("id")||i.data("uid"),a=s.data("uid");$(this).addClass("disabled"),utils.api("/_bridge/admin/check/brush",{data:{id:u}}).done(function(r){var i=r.data.resp.uid;utils.api("/client/login",{method:"post",data:{uid:i,type:"brush"}}).done(function(r){var i=r.data.resp.token;if(r["node_code"]!=2e4){utils.bubble(r.data.msg),$(t).removeClass("disabled");return}var f=r.data.resp.user;utils.api("/client/comment/append",{method:"post",data:{token:i,atlasId:e.data("atlasid"),replyId:a,content:n}}).done(function(n){if(n["node_code"]!=2e4){utils.bubble(n.data.msg),$(t).removeClass("disabled");return}s.length<1&&o(f.nickname,i,e.find(".from img").data("id")),$(t).removeClass("disabled"),e.find(".speak-here .list .desc").remove();var r=n.data.resp.comments[0],a=_.template(l,{id:u,nickname:f.nickname,applyusername:r.replyUser&&r.replyUser.nickname,headUrl:f.headUrl,content:r.content,commentID:r.id});e.find(".speak-here .list ul").append(a),e.find(".speak-here .list").scrollTop(e.find(".speak-here .list ul").height()),e.find(".speak-here .list ul li:last").addClass("animated bounceIn"),e.find("textarea").val(""),utils.bubble("成功添加评论！")})})})})}function h(e){e.on("click",".item img",function(){e.find(".robot .robotman.selected").removeClass("selected");var t=$(this).parent().data("uid"),n=this,r=$(n).parent();r.addClass("selected");var i=r.find(".speaker").text();utils.api("/_bridge/admin/check/brush",{data:{id:t}}).done(function(e){var t=e.data.resp.check;if(!t)return r.removeClass("selected"),utils.bubble("真实用户～你懂得");r.siblings().removeClass("selected"),r.removeClass("apply").addClass("selected"),utils.bubble("您选择了"+i+"作为评论人")})})}function p(e){e.on("click",".item .content",function(){var e=$(this).parents(".item"),t=e.find(".speaker").text();if(e.hasClass("apply"))return e.removeClass("apply");e.siblings().removeClass("apply"),e.removeClass("selected").addClass("apply"),utils.bubble("你将回复"+t+"的评论")})}var e=[],t=['<li class="robotman" data-id="<%= uid %>" data-name="<%= nickname %>">',' <img src="<%= headUrl %>" alt="">',"</li>"].join(""),n=['<li class="item" data-uid="<%= id %>">','  <img src="<%= headUrl %>" alt="" />',' <div class="cmt">','       <div class="origin">','            <p class="user"><%= nickname %> </p>','            <p class="time">just now</p>',"        </div>",'      <div class="content"> <%= content %> </div>'," </div>",'  <p class="close" data-id="<%= commentID %>">删除</p>',"</li>"].join(""),r=null;$.extend(s.prototype,{getCurIndex:function(){return this._cur},setCurByContent:function(e){var t=this.list.indexOf(e);this._cur=t,$scope.find(".thumbs li").eq(t).addClass("on").siblings().removeClass("on")},getCurContent:function(){return this.list[this._cur]},append:function(){var e=[].concat([],arguments);this.list.push.apply(this.list,e)},prev:function(){var e=this._cur;return e==-1?(this._cur=e,{index:e,content:null}):e==0?(e=this.list.length-1,this._cur=e,{index:e,content:this.list[e]}):(e--,this._cur=e,{index:e,content:this.list[e]})},next:function(){var e=this._cur;return e==-1?(this._cur=e,{index:e,content:null}):e+1==this.list.length?(this._cur=0,{index:0,content:this.list[0]}):(e++,this._cur=e,{index:e,content:this.list[e]})}}),_bindEvents=function(){$(window).on("resize",function(e){i()}),$scope.find(".img img").mousemove(function(e){var t=e.offsetX,n=$(this).width()/2;t>=n?$(this).removeClass("left"):$(this).addClass("left")}),$scope.find(".img img").click(function(e){if($(this).hasClass("left")){var t=r.prev();$scope.find(".img img").attr("src",t.content)}else{var t=r.next();$scope.find(".img img").attr("src",t.content)}var n=$scope.find(".thumbs li").eq(t.index),s=n.parents(".wrap"),o=n.offset(),u=s.offset();n.addClass("on").siblings().removeClass("on"),o.top<u.top?s.animate({scrollTop:0}):o.top>u.top+s.outerHeight()&&s.animate({scrollTop:1e4}),i()}),$scope.find(".thumbs img").click(function(){var e=$(this).attr("src");$scope.find(".img img").attr("src",e),r.setCurByContent(e),i()}),$scope.on("dblclick",".list .item",function(e){$(this).find(".close").addClass("animated bounceInRight")}),$scope.on("mouseleave",".list .item",function(e){$(this).find(".close").removeClass("animated bounceInRight")}),$scope.on("click",".list .item .close",function(e){var t=$(this).data("id");utils.api("/_bridge/admin/comment/delete",{method:"post",data:{id:t}}).done(function(t,n){if(t["node_code"]!=2e4){utils.bubble(t.data.msg);return}$(e.target).parents(".item").addClass("animated zoomOutRight"),$(e.target).parents(".item").one("webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend",function(){$(this).remove()})})}),$scope.on("click",".followers .robotman",function(e){$scope.find(".speak-here li.selected").removeClass("selected");var t=$(this).data("name");$(this).hasClass("selected")?$(this).removeClass("selected"):($(this).addClass("selected").siblings().removeClass("selected"),utils.bubble("你选择了"+t+"作为评论人"),setTimeout(function(){$scope.find(".followers").removeClass("show")},600))}),$scope.on("click",".followers .pull",function(e){$scope.find(".followers").hasClass("show")?$scope.find(".followers").removeClass("show"):$scope.find(".followers").addClass("show")})};var l=['<li class="item" data-uid="<%= id %>">','    <img src="<%= headUrl %>" alt=""/>','  <div class="cmt">','       <div class="origin">','            <p class="user"><%= nickname %>',"         <%if (applyusername) { %>",'               <span style="color:blue;">回复</span><%= applyusername %>',"         <% } %> ","            </p>",'            <p class="time">just now</p>',"        </div>",'      <div class="content"> <%= content %> </div>'," </div>",'  <p class="close" data-id="<%= commentID %>">删除</p>',"</li>"].join("");return{init:function(){$scope=$(".mod-atlas-preview"),$scope.find(".thumbs li:first").addClass("on"),e=[],$scope.find(".wrap img").map(function(t,n){var r=$(n).attr("src");return e.push(r),r}),a($scope),f($scope),p($scope),h($scope),c($scope),_bindEvents($scope),i(),r=new s({list:e,target:$scope.find(".img img")})}}})