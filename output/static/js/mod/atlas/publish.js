define(["base/draggabilly.pkgd","mod/common/widget/suggestion","mod/common/widget/labelhistory"],function(e,t,n){function h(e){f=WebUploader.create({swf:"/static/webuploader/Uploader.swf",server:"/upload/media",pick:"#picker",fileVal:"files",threads:4,fileNumLimit:6,formData:{__no_retain__:"ok"},fileSingleSizeLimit:1e7,dnd:".drop-zone",duplicate:!1,auto:!0,thumb:{width:400,height:400,crop:!1},compress:{width:2400,height:2400,crop:!1,preserveHeaders:!0,noCompressIfLarger:!0},accept:{title:"Images",extensions:"jpg,jpeg,bmp,png",mimeTypes:"image/*"}}),f.on("filesQueued",function(t){_.each(t,function(t,n){f.makeThumb(t,function(n,r){if(n)return;e.find(".sub-left .container .tip").remove();var s=_.template(i,{src:r,name:t.name,id:t.__hash,fid:t.id});$prev=$(s),e.find(".sub-left .container .progress-box").length==0&&$prev.addClass("cover"),e.find(".sub-left .container").append($prev)})})}),f.on("uploadSuccess",function(t,n){if(n.node_code!==2e4)return $("#"+t.__hash,e).find(".progress").addClass("warning");var r=n.data.resp.images[0].id;$("#"+t.__hash,e).attr("data-id",r).find(".stick").width("100%"),setTimeout(function(){$("#"+t.__hash,e).attr("data-id",r).find(".stick").remove(),utils.bubble("图片上传成功！")},400)}),f.on("uploadError",function(t,n){utils.bubble("上传错误！"),$("#"+t.__hash,e).find(".stick").width("100%")}),f.on("uploadProgress",function(t,n){$("#"+t.__hash,e).find(".stick").width(n*62+"%")}),f.on("error",function(e){var t=this.getFiles().length;switch(e){case"Q_TYPE_DENIED":alert("错误的资源！");break;case"Q_EXCEED_NUM_LIMIT":utils.bubble("分批文件限制为"+t+"个！（可再次追加）");break;case"Q_EXCEED_SIZE_LIMIT":alert("文件体积过大");break;case"F_EXCEED_SIZE":alert("文件体积过大")}})}function p(e){e.find(".dist").distpicker({})}function d(e){e.on("click",".btn-submit",function(t){function r(){n.remove(),e.find(".progress-box").remove(),e.find(".row.imgids").empty(),e.find(".row.labelids").empty(),e.find("form").clearForm(),f.reset()}var n=null;if($(".text-link").length){var i=$.map($(".text-link"),function(e,t){return $(e).find("input:first").val()?$(e).find("input:last").val()?!0:($(e).find("input:last").focus(),!1):($(e).find("input:first").focus(),!1)});if(i.indexOf(!1)>=0){utils.bubble("文字链内容不能为空！");return}}if(f.getStats().progressNum){utils.bubble("请等待图片上传完成！");return}if(e.find(".sub-left .progress-box").length<=0){utils.bubble("请上传图片！");return}var s=e.find(".sub-left .cover .label-item");if(s.length<=0){utils.bubble("请添加标签！");return}if(!e.find(".row select.location").val()){utils.bubble("请选择城市，不要老选择北京哦！");return}var o=e.find(".sub-left .cover"),u=_.map(s,function(t,n){function h(e){if(e<0)return 0;if(e>1)return;return e}var r=$(t),i=r.find(".dot"),s=i.offset(),u=i.parents(".progress-box").offset(),a=parseInt(s.left-u.left),f=parseInt(s.top-u.top),l=a/o.width(),c=f/o.height();return e.find(".labelids").append($("<input />",{value:r.data("id"),name:"labelIds"})),{id:r.data("id"),name:r.text(),brand:r.data("brand")||0,type:r.data("type"),toLeft:!r.hasClass("label-item-right"),x:h(l),y:h(c),affiliate:""}}),a=e.find(".category-list .category-list-item.selected");if(a.length<=0)return utils.bubble("请选择分类");var l=[];a.map(function(e,t){var n=$(t).data("id");return l.push(n),n}),_.map(e.find(".sub-left .progress-box"),function(t,n){var r=$(t);e.find(".imgids").append($("<input />",{value:r.data("id"),name:"imageIds"}))});var c={coverImageId:o.data("id"),remark:JSON.stringify(u),interestIds:l.join(",")};e.find("form").ajaxSubmit({data:c,beforeSubmit:function(){return n=utils.loading(),!0},uploadProgress:function(){},success:function(e,t){e["node_code"]==2e4&&(utils.bubble("发布成功"),r(),_SmartPipe_.reload())},fail:function(e,t){utils.bubble("失败了")}})})}function v(e){e.find('input[name="popout"]').on("click",function(t){this.checked?e.find("form").attr("action","/_bridge/admin/atlas/top/add"):e.find("form").attr("action","/_bridge/admin/atlas/add")})}function m(e){var t=10,n=$(".datetimepicker",e),r=new Date,i=new Date(+r+6e4*t),s=new Date(+r+2592e6),o=[i.getFullYear(),i.getMonth()+1,i.getDate()].join("/"),u=[s.getFullYear(),s.getMonth()+1,s.getDate()].join("/"),a=n.datetimepicker({format:"Y-m-d H:i:s",lang:"ch",step:t,minDate:o,maxDate:u,yearStart:i.getFullYear(),validateOnBlur:!0,defaultSelect:!1,onChangeDateTime:function(e,t){if(!e)return;var n=new Date(+(new Date)+6e5);if(+e<+n)return utils.bubble("距离发布时间太近了！"),t.val(""),!1}});e.on("click",".clear-timer",function(e){a.val("")})}function g(e){e.on("click",".btn-add-textlink",function(e){$tmplTextLink=$(s),$prev=$(this).prev();if($prev.length){if(!$prev.find("input:first").val()){$prev.find("input:first").focus();return}if(!$prev.find("input:last").val()){$prev.find("input:last").focus();return}}$tmplTextLink.insertBefore($(this))})}function y(e){e.on("click",".destroy",function(e){$(e.target).parents(".text-link").remove()})}function b(e){e.on("click",".pre-box .close",function(e){var t=$(this).parents(".progress-box"),n=t.data("id"),r=t.data("fid");$(".imgids").find('input[value="'+n+'"]').remove(),t.remove(),f.removeFile(r)})}function w(e){e.on("click",".btn-fav-label, .label-history-box .close",function(e){l.isShow()?l.hide():l.show()})}function E(e){e.on("dblclick",".label-history-box .label-item",function(e){var t=$(this).data("id"),n=this;l.removeRemoteRecord(t,function(){$(n).remove(),utils.bubble("标签已经从云端移除")})})}function S(e){e.on("mousedown",".progress-box",function(e){if($(e.target).hasClass("label-item"))return;$(this).data("_pressed_time_",+(new Date))}),e.on("mouseup",".progress-box",function(e){var t=parseInt($(this).data("_pressed_time_"));$(this).data("_pressed_time_",null);if($(e.target).hasClass("label-item"))return;if(isNaN(t))return;if($(this).find(".destroy").length>=1)return;if(+(new Date)-t>2e3){var n=$('<div class="destroy"> ╳ </div>'),r=$(this).append(n);n.click(function(){f.removeFile(r.data("fid")),r.hasClass("cover")&&r.siblings().eq(0).addClass("cover"),r.remove()}),n.animate({opacity:.5},3200,function(e){$(this).remove()})}})}function x(e){l=new n({el:e.find(".label-history-box")[0],itemTemplate:o,onLoaded:function(){e.find(".label-item").draggable({})},onIterationItem:function(t){var n=e.find(".label-group"),r=$(_.template(o,t));r.addClass("marked");var i=e.find(".label-item[data-id="+t.id+"]");i.length==1&&i.remove(),n.prepend(r)}})}function T(t){t.find(".sub-left .container").droppable({}).on("drop",function(t){var n=$(t.currentTarget.lastChild),r=n.data("id"),i=n.data("type"),s=n.data("brand"),o=n.text(),a={id:r,name:o,brand:s,type:i};n.remove();var f=$(t.target);if($(this).find(".progress-box").length==0){utils.bubble("请上传图片后拖放！");return}if(f.is(".container")){utils.bubble("请放到高亮的图片上！");return}f.is("img")&&(f=f.parents(".progress-box"));if(!f.hasClass("cover")){utils.bubble("双击我，高亮后可拖放标签！");return}if(f.find(".label-item").length>=5){utils.bubble("最多5个标签哦！");return}if(f.find(".label-item[data-id="+a.id+"]").length>=1){utils.bubble(a.name+" 已加入！");return}var l=t.originalEvent.offsetX-20,c=t.originalEvent.offsetY-20,h=function(){return{width:f.width(),height:f.height()}}(),p=$(_.template(u,a)).css({left:l,top:c});l>h.width/2&&p.addClass("label-item-right"),f.append(p),p.addClass("animated bounceIn"),p.one("webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend",function(){p.removeClass("animated bounceIn")});var d=new e(p[0],{containment:f[0]});d.measureContainment(),d.on("dragEnd",function(e){})})}function N(e){e.find(".label-history-box").droppable({}).on("drop",function(e){var t=$(e.currentTarget.lastChild),n=t.data("id"),r=t.data("type"),i=t.data("brand"),s=t.text(),u={id:n,name:s,brand:i,type:r},a=$(l.el).find(".label-item[data-id="+u.id+"]");a.remove(),t.remove(),$(this).find(".main").append(_.template(o,u)),l.appendRecordToRemote(n,u,function(e){utils.bubble("标签已经收藏到云端")})})}function C(e){new t({el:e.find(".label-search-box input"),elSuggestBox:e.find(".ui-suggestion"),url:window._NA_.api_domain+"/label/search",keyName:"name",baseParams:{key:"",page:1,limit:10},tmplSuggestItem:a,itemSelector:".item",onStart:function(){this.$el.parent().addClass("loading")},onEnd:function(){this.$el.parent().removeClass("loading")},format:function(e){return e.resp.labels},itemFormat:function(e){return{id:e.id,name:e.name,brand:e.brand,type:e.type,imgUrl:e.imgUrl||""}},onItemSelect:function(t){var n=$(t),r={id:n.data("id"),name:$.trim(n.text()),brand:n.data("brand"),type:n.data("type")},i=$(_.template(o,r));e.find(".label-group").find(".label-item[data-id="+r.id+"]").remove(),i.prependTo(e.find(".label-group")),i.draggable({}),n.addClass("animated zoomOutUp"),n.one("webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend",function(){n.remove()})}})}function k(e){e.on("dblclick",".sub-left .container .progress-box .label-item .dot",function(e){e.preventDefault(),e.stopPropagation();var t=$(this).parent();return t.hasClass("label-item-right")?t.removeClass("label-item-right"):t.addClass("label-item-right"),!1})}function L(e){e.on("dblclick",".sub-left .container .progress-box .label-item",function(e){$(this).remove()})}function A(e){e.on("dblclick",".sub-left .container .progress-box",function(e){$(this).siblings().find(".label-item").remove(),$(this).addClass("cover").siblings().removeClass("cover")})}function O(e){e.on("focus",".sub-right .textarea-change-event",function(t){var n=this,i,s,o,u;c=setInterval(function(){i=$(n).val().length,s=r-i,s<0?(s=0,e.find(".sub-right .textarea-tips").html("已经超出字数的最大限制!")):e.find(".sub-right .textarea-tips").html('还可输入 <span class="textarea-tips-num" style="font-size: 16px;"> '+s+" </span> 字(共计"+r+"字)")},400)})}function M(e){e.find(".sub-right .textarea-change-event").maxlength({feedback:""})}function D(e){e.on("click",".category-list li",function(e){if($(this).hasClass("selected"))return $(this).removeClass("selected");$(this).addClass("selected")})}function P(e){d(e),g(e),y(e),b(e),v(e),k(e),w(e),E(e),A(e),S(e),O(e),M(e),D(e)}var r=140,i=['<div class="progress-box" draggable="false" id="<%= id %>"   data-fid="<%= fid %>" >','<div class="stick"></div>','<div class="wrap">','<img src="<%= src %>" draggable="false" title="<%= name %>" alt="<%= name %>" /> ','<span class="close"></span>',"</div>","</div>"].join(""),s=['<div class="text-link">','<div class="ui form">','<div class="field">','<input type="text" name="linkNames" placeholder="文字（如：旅游）">',"</div>","</div>",'<div class="ui form">','<div class="field">','<input type="url" name="linkUrls" placeholder="链接：http://www.fmsjs.com">',"</div>","</div>",'<span class="destroy"></span>',"</div>"].join(""),o=['<div class="label-item" data-id="<%= id %>" data-type="<%= type %>" data-brand="<%= brand %>"><%= name %></div>'].join(""),u=['<div class="label-item" data-id="<%= id %>" data-type="<%= type %>" data-brand="<%= brand %>"><%= name %><p class="dot"></p></div>'].join(""),a=['<li class="item" data-id="<%= id %>" data-type="<%= type %>" data-brand="<%= brand %>">','    <img src="<%= imgUrl %>" alt="">','    <div class="name"><%= name %></div>',"<% if(brand == 1) { %>",'   <div class="brand"></div>',"<% } %>","</li>"].join(""),f=null,l=null,c=null;return{init:function(e){var t=$(".mod-publish");globFnWatchResize(function(e){var n=e.h-$("#header").outerHeight();t.find(".sub-left .container").height(n-20)}),h(t),p(t),m(t),x(t),P(t),C(t),N(t),T(t),L(t)}}})