define(function(){"use strict";function e(e){this.options=_.extend({el:"",prefix:_NA_.uid+"_label_",itemTemplate:"no template",remoteFormat:function(e){var t=e.data.resp.adminMessage.message,n={};try{n=JSON.parse(t)}catch(r){n={},console.warn(r)}return n},onIterationItem:function(){},onLoaded:function(){},onInitialize:function(){}},e),this.el=this.options.el,this.init()}return _.extend(e.prototype,{init:function(){this.loadRemote(),this.options.onInitialize.call(this)},show:function(){$(this.el).addClass("show")},isShow:function(){return $(this.el).hasClass("show")},hide:function(){$(this.el).removeClass("show")},removeRecord:function(e,t){var n=this.options.prefix;localforage.removeItem(n+e,t)},removeRemoteRecord:function(e,t){var n=this;this.getRemoteData(function(r){var i=n.options.remoteFormat(r);labelMap=i.label_||{},delete labelMap[e],i.label_=labelMap;var s=JSON.stringify(i);utils.api("/_bridge/admin/self/message/add",{method:"post",data:{message:s}}).done(t)})},appendRecord:function(e,t,n){var r=this.options.prefix;this.removeRecord(e,function(){localforage.setItem(r+e,t,n)}),this.appendRemoteData(r+e,t,n)},getAllRecords:function(e){var t=this.options.prefix,n=this,r=[];localforage.iterate(function(e,n){n.indexOf(t)==0&&e.name&&r.push(e)}).then(function(){e(r)})},loadRemote:function(){var e=this;this.getRemoteData(function(t){var n=e.options.remoteFormat(t),r=n.label_||{};for(var i in r){var s=r[i];if(typeof s["type"]=="undefined"){e.removeRecord(s.id);continue}e.options.onIterationItem.call(e,s),$(e.el).find(".main").append(_.template(e.options.itemTemplate,s))}e.options.onLoaded.call(e,r,"remote")})},loadLocal:function(){var e=this;this.getAllRecords(function(t){for(var n=t.length-1;n>=0;n--){var r=t[n];if(typeof r["type"]=="undefined"){e.removeRecord(r.id);continue}e.options.onIterationItem.call(e,r),$(e.el).find(".main").append(_.template(e.options.itemTemplate,r))}e.options.onLoaded.call(e,t)})},appendRecordToRemote:function(e,t,n){var r=this;this.getRemoteData(function(i){var s=r.options.remoteFormat(i),o=s.label_||{};o[e]=t,s.label_=o;var u=JSON.stringify(s);utils.api("/_bridge/admin/self/message/add",{method:"post",data:{message:u}}).done(n)})},getRemoteData:function(e){utils.api("/_bridge/admin/self/message").done(function(t){e.call(null,t)})}}),e})