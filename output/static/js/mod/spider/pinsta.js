define(function(){var e=['<div class="item">','    <a href="/atlas/<%= id %>/detail?" title="查看图集" target="_blank">','        <img style="<%= imgStyle %>" src="<%= imageUrl %>"  alt="">',"    </a>",'    <div class="user">','        <img src="<%= headUrl %>">','        <div class="name"><%= nickname %></div>',"    </div>","</div>"].join("");return{init:function(){var t=0,n=0,r=$(".mod-spider-pinsta"),i=r.find("input.input-pinsta-user"),s=__getSocketSingleton__();s.on("producer_feedback",function(e,o){console.log(e,o);switch(e){case"producer_task_start":var u=o.startPage;/^http:\/\/pinsta.me/i.test(u)||(u="http://pinsta.me/"+u),u==$.trim(i.val())&&(i.attr("disabled",!1).removeClass("disable").parent().removeClass("loading"),i.val(""),utils.bubble(o.startPage+"<br />已经开始启动"));break;case"user_update":o["node_code"]==2e4&&s.emit("request_user_count");break;case"not_reach":utils.bubble("链接不可用<br/>请检查URL或网络"),i.attr("disabled",!1).removeClass("disable").parent().removeClass("loading");break;case"item_save_ok":t++,r.find(".produce span").text(t);break;case"item_exists":var a=r.find(".status-bar .repeat-check span");a.find("i").text(++n),a.css({background:"red"}),setTimeout(function(){a.css({background:"green"})},400)}}),s.on("consumer_feedback",function(t,n){console.log(new Date,t,n);switch(t){case"publish_ok":var i=n.atlas.data.resp,s=n.user.data.resp.user,o=function(e){var t=e.coverKey[0].size.split("*"),n=t[0],r=t[1]||100,i=n/r,s=";width: 100%; height: auto;";return i<=1&&(s=";width: auto; height: 100%;"),s}(i),u=_.template(e)({imageUrl:i.coverKey[0].thumb.url,id:i.atlas.id,imgStyle:o,headUrl:s.headUrl,nickname:s.nickname,firstLogin:s.firstLogin});r.find(".spider-terminal").append(u);break;case"read_users_null":utils.bubble("您需要添加图集或者新的用户");break;case"wait_user_inserted_and_restart":utils.bubble("您需要添加图集或者新的用户<br>"+n.delay/1e3+"秒后重传");break;case"user_without_atlas_fetch_atlas":n["msgType"]=="producer_task_start"&&utils.bubble("用户正在补充图集资源")}}),s.on("push_task_state",function(e){switch(e){case"start":utils.bubble("已开启"),r.find(".btn-switch .button.btn-on").addClass("positive").siblings().removeClass("positive");break;case"stop":utils.bubble("服务器重启过后<br />任务还没开启？"),r.find(".btn-switch .button.btn-off").addClass("positive").siblings().removeClass("positive")}}),s.on("push_users_count",function(e){e["node_code"]==2e4&&r.find(".status-bar .user-count span").text(e.data)}),s.on("su_do",function(e){console.log(e)}),s.on("push_users_delete",function(e){e["node_code"]==2e4&&utils.bubble("删除成功！")}),s.on("push_atlas_count",function(e){var t=e[0].data,n=e[1].data;r.find(".status-bar .rate .avail").text(t),r.find(".status-bar .rate .total").text(n)}),r.on("click",".btn-submit",function(e){var t=i.val();if(!t)return utils.bubble("连接不能为空！");i.attr("disabled",!0).addClass("disable").parent().addClass("loading"),/^http:\/\/pinsta.me/i.test(t)||(t="http://pinsta.me/"+t),s.emit("request_spider",{url:$.trim(t)})}),r.on("click",".btn-delete-users",function(e){var t=r.find(".input-delete-users").val();if(!t)return utils.bubble("不能为空！");dialog({title:"修改",align:"bottom left",content:"你确定要删除么？",okValue:"提交",cancelValue:"取消",ok:function(){return s.emit("request_delete_users",t),!0},cancel:function(){return!0}}).showModal(e.target),s.emit("delete_users",{users:$.trim(t)})}),r.on("click",".btn-switch .button",function(e){s.emit("request_task_switch",{state:$(this).data("state")})}),r.on("click",".button.btn-fetch-users",function(e){s.emit("request_users_avail",10800,8)}),r.on("click",".paw",function(e){var t=i.val();t=t.replace("http://pinsta.me/",""),s.emit("request_user_check",t)}),r.on("click",".btn-atlas-count",function(e){s.emit("request_atlas_count")}),r.on("click",".btn-users-count",function(e){s.emit("request_users_count")}),r.on("click",".button.btn-fetch-atlas",function(e){var t=r.find(".input-users").val();t=t.split("，");if(t.length<=0)return;s.emit("request_atlas_avail_by_user_array",t)}),s.on("test_users_avail",function(e){var t=e.data,n=[];for(var i=0;i<t.length;i++)n.push(t[i].uid);r.find(".input-users").val(n.join("，"))}),s.on("test_atlas_avail_by_user_array",function(e){var t=e.uIDArrayWithoutAtlas.join("，");r.find(".input-users-without-atlas").val(t)}),s.on("test_user_check",function(e){var t=e[0],n=e[1],r=e[2];t.data?alert("图集可用／图集总数"+n.data+"/"+atlas.data):alert("用户不存在")})}}})