define(function(){function e(e){e.emit("request_user_count"),e.emit("request_task_state")}var t=['<div class="item">','    <a href="/atlas/<%= id %>/detail?" title="查看图集" target="_blank">','        <img style="<%= imgStyle %>" src="<%= imageUrl %>"  alt="">',"    </a>",'    <div class="user">','        <img src="<%= headUrl %>">','        <div class="name"><%= nickname %></div>',"    </div>","</div>"].join("");return{init:function(){var n=0,r=0,i=$(".mod-spider-weibo"),s=i.find("input.input-user"),o=i.find("input.input-cookie"),u=__getSocketSingleton__();u.on("connection",function(){e(this)}),u.on("producer_feedback",function(e,t){console.log(e,t);switch(e){case"producer_task_start":t["startPage"]==$.trim($input.val())&&($input.attr("disabled",!1).removeClass("disable").parent().removeClass("loading"),$input.val(""),utils.bubble(t.startPage+"<br />已经开始启动"));break;case"user_update":t["node_code"]==2e4&&u.emit("request_user_count");break;case"not_reach":utils.bubble("链接不可用<br/>请检查URL或网络"),$input.attr("disabled",!1).removeClass("disable").parent().removeClass("loading");break;case"item_save_ok":n++,i.find(".produce span").text(n);break;case"item_exists":var s=i.find(".status-bar .repeat-check span");s.find("i").text(++r),s.css({background:"red"}),setTimeout(function(){s.css({background:"green"})},400)}}),u.on("consumer_feedback",function(e,n){console.log(new Date,e,n);switch(e){case"publish_ok":var r=n.atlas.data.resp,s=n.user.data.resp.user,o=_.template(t)({imageUrl:"",id:"",imgStyle:"",headUrl:s.headUrl,nickname:s.nickname,firstLogin:s.firstLogin});i.find(".spider-terminal").append(o);break;case"read_users_null":utils.bubble("您需要添加图集或者新的用户");break;case"wait_user_inserted_and_restart":utils.bubble("您需要添加图集或者新的用户<br>"+n.delay/1e3+"秒后重传");break;case"user_without_atlas_fetch_atlas":n["msgType"]=="producer_task_start"&&utils.bubble("用户正在补充图集资源")}}),u.on("push_task_state",function(e){switch(e.type){case"new":utils.bubble("已开启"),i.find(".btn-switch .button.btn-on").addClass("positive").siblings().removeClass("positive");break;case"running":utils.bubble("已处于开启状态"),i.find(".btn-switch .button.btn-on").addClass("positive").siblings().removeClass("positive");break;case"kill":i.find(".btn-switch .button.btn-off").addClass("positive").siblings().removeClass("positive"),utils.bubble("已被关闭");break;case"dead":i.find(".btn-switch .button.btn-off").addClass("positive").siblings().removeClass("positive"),utils.bubble("已处于关闭状态");break;case"empty":utils.bubble("服务器重启过后<br />任务还没开启？"),i.find(".btn-switch .button.btn-off").addClass("positive").siblings().removeClass("positive")}}),u.on("push_user_count",function(e){e["node_code"]==2e4&&i.find(".status-bar .user-count span").text(e.data)}),u.on("push_blog_count",function(e){var t=e[0].data,n=e[1].data;i.find(".status-bar .rate .avail").text(t),i.find(".status-bar .rate .total").text(n)}),i.on("click",".btn-submit",function(e){var t=$input.val();if(!t)return utils.bubble("连接不能为空！");$input.attr("disabled",!0).addClass("disable").parent().addClass("loading"),/^http:\/\/pinsta.me/i.test(t)||(t="http://pinsta.me/"+t),u.emit("request_spider",{url:$.trim(t)})}),i.on("click",".btn-switch .button",function(e){u.emit("request_task_weibo_switch",{state:$(this).data("state")})}),i.on("click",".button.btn-fetch-users",function(e){u.emit("request_users_avail",10800,8)}),i.on("click",".btn-add-cookie",function(e){var t=$.trim(o.val());if(!t)return;u.emit("request_add_cookie",t)}),i.on("click",".btn-add-user",function(e){var t=$.trim(s.val());if(!t)return;u.emit("request_add_user_id",t)}),u.on("push_add_cookie",function(e){if(e["node_code"]==2e4)return utils.bubble("添加成功！")}),u.on("push_add_user_id",function(e){if(e["node_code"]==2e4)return utils.bubble("添加成功！")}),u.on("test_users_avail",function(e){var t=e.data,n=[];for(var r=0;r<t.length;r++)n.push(t[r].uid);i.find(".input-users").val(n.join("，"))}),u.on("test_atlas_avail_by_user_array",function(e){var t=e.uIDArrayWithoutAtlas.join("，");i.find(".input-users-without-atlas").val(t)}),u.on("test_user_check",function(e){var t=e[0],n=e[1],r=e[2];t.data?alert("图集可用／图集总数"+n.data+"/"+atlas.data):alert("用户不存在")})}}})